name: Cache Gradle
description: Improved cache for Gradle

inputs:
  gradle-user-home:
    required: false
    default: '~/.gradle'
    description: "Gradle user home directory (GRADLE_USER_HOME)"
  cache-version:
    required: true
    default: '1'
    description: "Cache version. Change it to reset cache."
  build-cache-enabled:
    required: true
    default: 'true'
    description: "Set to 'false' to disable Gradle Build Cache"
  build-cache-for-branches-only:
    required: true
    default: 'true'
    description: "Set to 'true' to disable Gradle Build Cache for tags"
  default-branch:
    required: false
    description: "Repository default branch. Will be retrieved from GitHub if not set."
  lookup-only:
    required: true
    default: 'false'
    description: "If true, only checks if cache entry exists and skips download. Does not change save cache behavior."
  github-job:
    required: true
    default: '${{github.job}}'
    description: "The current job ID"
  strategy-job-index:
    required: false
    description: "The index of the current job in the matrix"
  strategy-job-total:
    required: false
    description: "The total number of jobs in the matrix"

outputs:
  gradle-wrapper-cache-hit:
    description: "A boolean value to indicate an exact match was found for Gradle wrapper cache"
    value: ${{steps.gradle-wrapper.outputs.cache-hit}}
  gradle-caches-cache-hit:
    description: "A boolean value to indicate an exact match was found for Gradle caches cache"
    value: ${{steps.gradle-caches.outputs.cache-hit}}

runs:
  using: composite
  steps:
  - name: Calculate paths
    id: paths
    shell: bash
    env:
      INPUTS_GRADLE_USER_HOME: ${{inputs.gradle-user-home}}
    run: |
      if [ -n "$INPUTS_GRADLE_USER_HOME" ]; then
        GRADLE_USER_HOME="$INPUTS_GRADLE_USER_HOME"
        echo "GRADLE_USER_HOME=$GRADLE_USER_HOME" | tee -a $GITHUB_ENV
      fi
      if [ -z "$GRADLE_USER_HOME" ]; then
        GRADLE_USER_HOME="~/."
      fi
      echo "gradle-user-home=$GRADLE_USER_HOME" | tee -a $GITHUB_OUTPUT
      [[ "$GRADLE_USER_HOME" == "~" || "$GRADLE_USER_HOME" == ~/* ]] && GRADLE_USER_HOME_EXPANDED="${GRADLE_USER_HOME/#\~/$HOME}"
      echo "gradle-user-home-expanded=$GRADLE_USER_HOME_EXPANDED" | tee -a $GITHUB_OUTPUT

  - name: Cache Gradle wrapper
    id: gradle-wrapper
    uses: actions/cache@v4
    with:
      lookup-only: '${{inputs.lookup-only}}'
      key: v${{inputs.cache-version}}-gradle-wrapper-${{hashFiles('**/gradle/wrapper/gradle-wrapper.properties', '**/gradle/gradle-daemon-jvm.properties')}}
      path: |
        ${{steps.paths.outputs.gradle-user-home}}/wrapper/dists
      enableCrossOsArchive: true
  - name: Cache Gradle caches
    id: gradle-caches
    uses: actions/cache@v4
    with:
      lookup-only: '${{inputs.lookup-only}}'
      key: v${{inputs.cache-version}}-gradle-caches-${{hashFiles('**/gradle/wrapper/gradle-wrapper.properties', '**/gradle/gradle-daemon-jvm.properties', '**/*.gradle', '**/*.gradle.kts', '**/gradle.properties', '**/gradle.lockfile', '**/*-gradle.lockfile' , '**/gradle/*.versions.toml')}}
      path: |
        ${{steps.paths.outputs.gradle-user-home}}/caches
        ${{steps.paths.outputs.gradle-user-home}}/jdks
        ${{steps.paths.outputs.gradle-user-home}}/notifications
      enableCrossOsArchive: true
  - name: Cleanup Gradle wrapper cache
    if: ${{steps.gradle-wrapper.outputs.cache-hit != 'true' || steps.gradle-caches.outputs.cache-hit != 'true'}}
    uses: remal-github-actions/cache-gradle-cleanup-wrapper@v1

  - name: Setup Gradle Build Cache
    if: ${{inputs.build-cache-enabled == 'true' && (inputs.build-cache-for-branches-only == 'false' || github.ref_type == 'branch')}}
    shell: bash
    run: |
      mkdir -p ${{steps.paths.outputs.gradle-user-home}}
      echo "org.gradle.caching = true" >> ${{steps.paths.outputs.gradle-user-home}}/gradle.properties
      echo ::group::${{steps.paths.outputs.gradle-user-home}}/gradle.properties
      cat ${{steps.paths.outputs.gradle-user-home}}/gradle.properties
      echo "::endgroup::"

      mkdir -p ${{steps.paths.outputs.gradle-user-home}}/init.d
      cat <<EOF > ${{steps.paths.outputs.gradle-user-home}}/init.d/build-cache.gradle
      gradle.settingsEvaluated { settings ->
        settings.buildCache.local {
          File buildCacheDir = new File('${{steps.paths.outputs.gradle-user-home-expanded}}/.build-cache')
          println "buildCacheDir=" + buildCacheDir
          directory = buildCacheDir
        }
      }
      EOF
      echo ::group::${{steps.paths.outputs.gradle-user-home}}/init.d/build-cache.gradle
      cat ${{steps.paths.outputs.gradle-user-home}}/init.d/build-cache.gradle
      echo "::endgroup::"

  - name: Create Gradle Build Cache key
    if: ${{inputs.build-cache-enabled == 'true' && (inputs.build-cache-for-branches-only == 'false' || github.ref_type == 'branch')}}
    id: build-cache-key-info
    shell: bash
    env:
      BASE_KEY: v${{inputs.cache-version}}-gradle-build-cache-${{hashFiles('**/gradle/wrapper/gradle-wrapper.properties', '**/gradle/gradle-daemon-jvm.properties', '**/*.gradle', '**/*.gradle.kts', '**/gradle.properties', '**/gradle.lockfile', '**/*-gradle.lockfile' , '**/gradle/*.versions.toml')}}-${{inputs.github-job}}-${{inputs.strategy-job-index||strategy.job-index||'0'}}/${{inputs.strategy-job-total||strategy.job-total||'0'}}
    run: |
      BASE_KEY="$(printf "%s" "$BASE_KEY" | tr '{}[],;:\"'\''[:space:]' '-')"
      BASE_KEY="$(printf "%s" "$BASE_KEY" | tr -s '-')"
      echo "base-key=$BASE_KEY" | tee -a $GITHUB_OUTPUT
  - name: Retrieve repository info
    if: ${{inputs.build-cache-enabled == 'true' && (inputs.build-cache-for-branches-only == 'false' || github.ref_type == 'branch')}}
    id: repository-info
    shell: bash
    run: |
      REPO_JSON=$(curl -s "${{github.api_url}}/repos/${{github.repository}}" -H "Authorization: token ${{github.token}}")
      DEFAULT_BRANCH=$(echo $REPO_JSON | jq -r '.default_branch')
      echo "default-branch=$DEFAULT_BRANCH" | tee -a $GITHUB_OUTPUT
  - name: Cache Gradle Build Cache for branch
    if: ${{inputs.build-cache-enabled == 'true' && (inputs.build-cache-for-branches-only == 'false' || github.ref_type == 'branch')}}
    uses: actions/cache@v4
    with:
      lookup-only: '${{inputs.lookup-only}}'
      key: ${{steps.build-cache-key-info.outputs.base-key}}-${{github.ref}}-${{github.sha}}-${{github.run_attempt}}
      restore-keys: |
        ${{steps.build-cache-key-info.outputs.base-key}}-${{github.ref}}-${{github.sha}}-
        ${{steps.build-cache-key-info.outputs.base-key}}-${{github.ref}}-
        ${{steps.build-cache-key-info.outputs.base-key}}-refs/heads/${{github.base_ref && github.base_ref || steps.repository-info.outputs.default-branch}}-
      path: |
        ${{steps.paths.outputs.gradle-user-home}}/.build-cache
      enableCrossOsArchive: true
